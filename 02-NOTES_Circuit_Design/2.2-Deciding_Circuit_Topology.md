# Deciding Circuit Topology  
Ultimately, this solar charge controller has two objectives:  
  
1) Track MPP in order to extract maximum power from solar panel.  
2) Output appropriate voltage to charge a 12V Li-ion battery.   
  
**To satisfy objective 1-operate at MPP:** 
To maximise power, we set equivalent resistance a certain constant for which achieves MPP.  
E.G-BUCK CONVERTER
Req = Rload/D^2 = Req for MPP. (we control Duty cycle continuously to keep operating point at MPP)  
  
So, Duty cycle =sqrt(Rload/Req)  for set Req which gives MPP.  
E.g:
If optimum operating voltage of panel at an instant is 19.9V and power output 80w:  
P=IV  
80=I*19.9  
80/19.9=4.02 Amperes  
Req=V/I  
19.9/4.02=4.95 Ohms is optimal Req under these conditions for achieving MPP.

**To satisfy objective 2-set desired output voltage:**  
ASSUMING IDENTICAL TOPOLOGY (BUCK CONVERTER):
Output voltage also depends on Duty cycle, where Vin=Vout*D.  
E.g:  Using same power output as in example for objective 1:
P=IV
80w=I*14V (if 14V were desired)  
80w/14=I
I=5.71A  
Req=V/I= 
14V/5.71A=2.45 Ohms is required Req for achieving desired output voltage.  
  
We can clearly see that even for same power output conditions, we cannot achieve both MPP and desired output voltage, as these objectives-this applies to any of the topologies discussed in notes section.  
  
If we want Vout set to a specified value whilst tracking MPP, it is not possible for a simple buck or boost converter to achieve both of these parameters.  
  
This realisation left some vital design and scope decisions to be made, and I re-evaluated with the following propositions:  
1) - Keep Vout at desired value and drift from MPP as required to achieve this.  

2) - Keep as close to MPP as possible within specified voltage range  (approx 13.5V+-0.5V).

3) - Always operate at MPP, using a second stage switching converter to achieve specified voltage.  
  
In order to evaluate my best option, I used MATLAB to simulate the range of output voltages MPPT Buck converter would output if simply tracking MPP between 1 and 100w output, and with between 0.1 and 10 ohms load across output terminal.  
  
Details of MATLAB algorithm developed can be found in "2.2-Circuit Simulation"
 
The MATLAB simulation algoritm itself can be accessed below also:
[MATLAB SIMULATION] ()  
[MATLAB GRAPH] ()  
  
## Design Implications from MATLAB simulation 
  
We can see from this graph that there is a large voltage range for the buck converter if operating at MPP between 1w and 100w output power and 0.4 to 2 ohms output load.  (approaching nearly 0V and as high as 14V).  
  
Even if power was only harvested between 20% and 100% of potential available power range of output voltage would be from 2.9V to 14V. This shows that solutions 1 and 2 would be inadequate.  
  
Therefore I will be working with a first stage MPPT converter for MPPT stage and incorporate a cascaded buck/boost converter across the ouput in order to output required voltage.  
  
Using a cascaded converter presents further challenges in decoupling.  
  
I will be using different control frequency feedback loop for cascaded converter compared to MPPT stage so that the converters do not de-stabilise each other or cause unnecessary ripple.  

I will operate control algorithm at 100Hz for MPPT stage and 1kHz for buck/boost battery charger.  
This will ensure my control converters do not conflict each other.  

## CONTROL METHOD: Voltage Mode Control VS Current Mode Control  
**VOLTAGE MODE CONTROL:**  
Changes duty cycle based on voltage error at output.    
This method has a slow transient response when input power changes however due to input power being smoothed through inductor.  
**CURRENT MODE CONTROL**
Current mode control uses a shunt resistor in series with inductor, votage across shunt resistor is measured. Since resistance of shunt resistor is known, and voltage drop is monitored instantaneously, we can calculate max voltage drop to be reached before inductor should be turned off, and use this as voltage value for which comparator shuts off MOSFET.  
    
This reference voltage is set by microcontroller based on output voltage of converter.  
Note that whilst current switching control loop operates on a cycle by cycle basis using op amps and comparator, voltage control loop operates at much slower frequency (100Hz).  
  
By using an op-amp to control gate driver, we switch MOSFET off as soon as current hits a certain current threshold or current reference set by microcontroller algorithm based on output voltage.  
This adds over current protection to circuit, protecting Inductor and MOSFETs.  
   
Due to faster transient response and over current protection I will implement Current mode control.  
Since MPPT stage has voltage range of between 0.5 and 14V, and desired output voltage for charging will be between 13.0 and 14.0V, I will be using an 4-MOSFET buck/boost topology for second stage.  
 Initially I was planning on using Buck converter for MPPT stage however after MATLAB analysis I became aware that equivalent input resistance cannot be lower than Rload.  
 This is a major limitation of a buck converter and it cannot execute the function of providing required equivalent input resistance because of this fact. As we see on the MATLAB graph, we cannot achieve 100% power for buck converter once Req of cascaded converter exceeds 4 ohms.  
    
This comes from the limitation that duty cycle cannot be greater than 1 (switch cannot be on for more than 100% of the time)  
  
Verifying this:
100/19.97=5.01
19.97/5.01=3.99 ohms-Req necessary to operate at MPP at 100w.
if Rload is 4.0 Ohms:
3.99=4/D^2
D cannot be greater than 1. Therefore if Rload is greater than required equivalent resistance, it is not possible to operate at MPP.
This means that at no point can out buck converter reach or surpass an equivalent resistance of 4 ohms.
This is the main limitation of the buck converter.  
Due to this fact, I will use a 4-MOSFET buck/boost converter for MPPT stage.











